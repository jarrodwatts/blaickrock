import { Scraper } from "agent-twitter-client";

export default async function postTweet(
  scraper: Scraper,
  tweet: string,
  txHash: `0x${string}` | null
) {
  return await postTweetWithReceiptReply(scraper, tweet, txHash);
}

/**
 * Takes the tweet content and the tx hash of the trade and posts the tweet.
 * It posts 1-2 tweets:
 * 1. The tweet containing the commentary generated by the "intern" agent.
 * 2. If a transaction was executed, it will post a reply to the tweet with the Abscan link.
 * If it does multiple trades, I hope this fn doesn't break... hmm
 */
async function postTweetWithReceiptReply(
  scraper: Scraper,
  tweet: string,
  txHash: `0x${string}` | null
) {
  const tweetOne = await scraper.sendTweet(tweet);

  if (!txHash) {
    return tweetOne;
  }

  const tweetOneData = await tweetOne.json();

  // wait random value between 10 seconds and 42 seconds
  const waitTime = Math.floor(Math.random() * 32) + 10;
  console.log(`Waiting ${waitTime} seconds before posting second tweet...`);
  await new Promise((resolve) => setTimeout(resolve, waitTime * 1000));

  // If there was no first tweet, just skip reply
  if (!tweetOneData?.data?.create_tweet) {
    return tweetOne;
  }

  // Post Abscan link to the tweet as a reply
  const tweetTwo = await scraper.sendTweet(
    `https://abscan.org/tx/${txHash}`,
    tweetOneData?.data?.create_tweet?.tweet_results?.result?.rest_id
  );
  return tweetTwo;
}
